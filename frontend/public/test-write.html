<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ¸¬è©¦å¯«å…¥è³‡æ–™åº«</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
    button { background: #4ade80; color: #000; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
    pre { background: #2d2d2d; padding: 15px; border-radius: 5px; overflow-x: auto; }
    .ok { color: #4ade80; }
    .error { color: #f87171; }
  </style>
</head>
<body>
  <h1>ğŸ”¬ æ¸¬è©¦ Supabase å¯«å…¥</h1>
  <button onclick="testEnv()">1. æª¢æŸ¥ç’°å¢ƒè®Šæ•¸</button>
  <button onclick="testWrite()">2. æ¸¬è©¦å¯«å…¥è³‡æ–™åº«</button>
  <button onclick="testRead()">3. è®€å–è³‡æ–™åº«</button>

  <div id="result"></div>

  <script type="module">
    const result = document.getElementById('result')

    function log(msg, type = 'ok') {
      result.innerHTML += `<div class="${type}">${msg}</div>`
    }

    window.testEnv = function() {
      result.innerHTML = '<h2>ç’°å¢ƒè®Šæ•¸æª¢æŸ¥</h2>'

      const url = import.meta.env.VITE_SUPABASE_URL
      const key = import.meta.env.VITE_SUPABASE_ANON_KEY

      if (url) {
        log(`âœ… VITE_SUPABASE_URL = ${url}`, 'ok')
      } else {
        log(`âŒ VITE_SUPABASE_URL æœªè¨­å®š`, 'error')
      }

      if (key) {
        log(`âœ… VITE_SUPABASE_ANON_KEY = ${key.substring(0, 30)}...`, 'ok')
      } else {
        log(`âŒ VITE_SUPABASE_ANON_KEY æœªè¨­å®š`, 'error')
      }
    }

    window.testWrite = async function() {
      result.innerHTML = '<h2>æ¸¬è©¦å¯«å…¥</h2>'

      const url = import.meta.env.VITE_SUPABASE_URL
      const key = import.meta.env.VITE_SUPABASE_ANON_KEY

      if (!url || !key) {
        log('âŒ ç’°å¢ƒè®Šæ•¸æœªè¨­å®š', 'error')
        return
      }

      const testForm = {
        id: crypto.randomUUID(),
        user_id: 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11',
        title: 'æ¸¬è©¦å•å· - ' + new Date().toLocaleString('zh-TW'),
        description: 'é©—è­‰å¯«å…¥åŠŸèƒ½',
        questions: [],
        display_mode: 'step-by-step',
        status: 'active'
      }

      log(`ğŸ“ æº–å‚™å¯«å…¥: ${testForm.id}`)

      try {
        const response = await fetch(`${url}/rest/v1/forms`, {
          method: 'POST',
          headers: {
            'apikey': key,
            'Authorization': `Bearer ${key}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(testForm)
        })

        if (!response.ok) {
          const error = await response.text()
          log(`âŒ å¯«å…¥å¤±æ•— (${response.status}): ${error}`, 'error')
          return
        }

        const data = await response.json()
        log(`âœ… å¯«å…¥æˆåŠŸï¼`, 'ok')
        log(`<pre>${JSON.stringify(data, null, 2)}</pre>`)
        log(`<a href="/fill/${testForm.id}" target="_blank">ğŸ“‹ æ¸¬è©¦é€£çµ: /fill/${testForm.id}</a>`)
      } catch (e) {
        log(`âŒ éŒ¯èª¤: ${e.message}`, 'error')
      }
    }

    window.testRead = async function() {
      result.innerHTML = '<h2>è®€å–è³‡æ–™åº«</h2>'

      const url = import.meta.env.VITE_SUPABASE_URL
      const key = import.meta.env.VITE_SUPABASE_ANON_KEY

      if (!url || !key) {
        log('âŒ ç’°å¢ƒè®Šæ•¸æœªè¨­å®š', 'error')
        return
      }

      try {
        const response = await fetch(`${url}/rest/v1/forms?select=id,title&order=created_at.desc&limit=5`, {
          headers: {
            'apikey': key,
            'Authorization': `Bearer ${key}`
          }
        })

        if (!response.ok) {
          const error = await response.text()
          log(`âŒ è®€å–å¤±æ•—: ${error}`, 'error')
          return
        }

        const data = await response.json()
        log(`âœ… è®€å–æˆåŠŸï¼Œæ‰¾åˆ° ${data.length} å€‹å•å·`)
        log(`<pre>${JSON.stringify(data, null, 2)}</pre>`)
      } catch (e) {
        log(`âŒ éŒ¯èª¤: ${e.message}`, 'error')
      }
    }
  </script>
</body>
</html>
